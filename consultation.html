<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì´ìŠ¤íŠ¸ìˆ˜í•™í•™ì› - ì…í•™í…ŒìŠ¤íŠ¸ ë° ìƒë‹´ ì˜ˆì•½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .option-card.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
            color: #312e81;
            font-weight: 700;
        }

        .time-grid::-webkit-scrollbar {
            width: 6px;
        }

        .time-grid::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        input[type="date"] {
            position: relative;
            padding-right: 10px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        /* Custom Modal Styles */
        #custom-modal {
            transition: opacity 0.3s ease-in-out;
        }

        #custom-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #custom-modal:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>

<body class="bg-stone-50 text-stone-800 antialiased min-h-screen flex flex-col">

    <header class="bg-white shadow-sm border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div
                    class="w-18 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg px-2">
                    KAIST</div>
                <h1 class="text-xl font-bold text-stone-800 tracking-tight">ì¹´ì´ìŠ¤íŠ¸ìˆ˜í•™í•™ì›</h1>
            </div>
            <div class="text-sm font-medium text-stone-500 hidden sm:block">ì…í•™í…ŒìŠ¤íŠ¸ ë° ìƒë‹´ ì˜ˆì•½</div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-4 sm:p-6">
        <div id="app-container"
            class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden transition-all duration-300 min-h-[600px] flex flex-col">
            <div class="w-full bg-stone-100 h-2">
                <div id="progress-bar" class="bg-indigo-600 h-2 transition-all duration-500 ease-out" style="width: 0%">
                </div>
            </div>
            <div id="step-content" class="p-6 sm:p-10 flex-grow flex flex-col relative"></div>
            <div
                class="bg-stone-50 px-6 py-4 flex justify-between items-center border-t border-stone-200 rounded-b-2xl">
                <button id="btn-prev"
                    class="px-6 py-2 rounded-lg text-stone-500 font-medium hover:bg-stone-200 transition-colors hidden">ì´ì „</button>
                <button id="btn-next"
                    class="px-8 py-2 rounded-lg bg-indigo-600 text-white font-bold shadow-md hover:bg-indigo-700 transition-transform transform active:scale-95 ml-auto flex items-center justify-center"><span>ì‹œì‘í•˜ê¸°</span></button>
            </div>
        </div>
    </main>

    <footer class="bg-stone-100 border-t border-stone-200 mt-8 py-8">
        <div class="max-w-4xl mx-auto px-4 text-center text-stone-500 text-sm">
            <p class="mb-2 font-semibold">ì¹´ì´ìŠ¤íŠ¸ìˆ˜í•™í•™ì›</p>
            <p>ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ í‰ë‚´ë™ 579-2 ê°•ë‚¨í”„ë¼ì 703í˜¸, 704í˜¸ | ë¬¸ì˜: 031-591-2194</p>
            <p class="mt-4 text-xs text-stone-400">1ë“±ê¸‰ì˜ ìƒê°ìœ¼ë¡œ ìˆ˜í•™ì„ ê³µë¶€í•©ë‹ˆë‹¤</p>
        </div>
    </footer>

    <div id="custom-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                    <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">ì•Œë¦¼</h3>
                <p id="modal-message" class="text-sm text-gray-500 mb-6 whitespace-pre-wrap"></p>
                <button onclick="closeModal()"
                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <script>
        // [ì„¤ì •] GAS ì›¹ ì•± URL (ë°°í¬ í›„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
        const API_URL = "https://script.google.com/macros/s/AKfycbw1kl9ykO4FC1HCpejFuKQE2YZL6JSCnja2sLAuFlCwDKijP4BVhuBrPGASZ3b_yYp7/exec";
        

// https://script.google.com/macros/s/AKfycbwGkrnysBSx7BLZkerKU-Wj1rRxkoIY8mfLANjuLR_3nDrMBiAlJj7OZ8Y6Bv94Fiyj/exec
// https://script.google.com/macros/s/AKfycbwcjqryRhISQrQLWlhg8TIIQfP4kJwjCTPQF-7MoDxtcyxtZASFPw6KTtaiEk_fEara/exec
        // Custom Modal Functions
        function showAlert(msg) {
            document.getElementById('modal-message').innerText = msg;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        const schoolsData = {
            elementary: ["ì‹ ì´Œì´ˆ", "ì¥ë‚´ì´ˆ", "í‰ë‚´ì´ˆ", "ë°±ë´‰ì´ˆ", "ì‹¬ì„ì´ˆ", "ì†¡ë¼ì´ˆ", "ì§ì ‘ì…ë ¥"],
            middle: ["ì¥ë‚´ì¤‘", "í‰ë‚´ì¤‘", "íŒê³¡ì¤‘", "í˜¸í‰ì¤‘", "ì‹¬ì„ì¤‘", "ë§ˆì„ì¤‘", "ì²œë§ˆì¤‘", "ì§ì ‘ì…ë ¥"],
            high: ["í‰ë‚´ê³ ", "íŒê³¡ê³ ", "í˜¸í‰ê³ ", "ì‹¬ì„ê³ ", "ë§ˆì„ê³ ", "ì§ì ‘ì…ë ¥"]
        };

        const learningMethods = [
            { id: 'large_academy', label: 'ëŒ€í˜• í•™ì›', icon: 'ğŸ¢' },
            { id: 'general_academy', label: 'ì¼ë°˜ ë³´ìŠµí•™ì›', icon: 'ğŸ«' },
            { id: 'small_group', label: 'ì†Œìˆ˜ ì •ì˜ˆ/êµìŠµì†Œ', icon: 'ğŸ‘¨â€ğŸ«' },
            { id: 'tutoring_worksheet', label: 'ê°œì¸ ê³¼ì™¸/í•™ìŠµì§€', icon: 'ğŸ“' },
            { id: 'self', label: 'ì¸ê°• ë° ë…í•™', icon: 'ğŸ“š' },
            { id: 'none', label: 'í•™ìŠµ ì—†ìŒ', icon: 'ğŸš«' }
        ];

        const moveReasons = [
            { id: 'grades', label: 'ì„±ì ì´ ì˜¤ë¥´ì§€ ì•Šì•„ì„œ' },
            { id: 'pace', label: 'ì§„ë„ ì†ë„ ë§Œì¡±ìŠ¤ëŸ½ì§€ ì•Šì•„ì„œ (ë¹ ë¦„/ëŠë¦¼)' },
            { id: 'concept', label: 'ê°œë… ì„¤ëª… ë¶€ì¡±í•˜ê³  ë¬¸ì œ í’€ì´ ìœ„ì£¼ë¼ì„œ' },
            { id: 'management', label: 'ìˆ™ì œ/ì˜¤ë‹µ ê´€ë¦¬ ë¶€ì¡±í•˜ë‹¤ê³  ëŠê»´ì„œ' },
            { id: 'feedback', label: 'ì§ˆë¬¸í•˜ê¸° ì–´ë ¤ìš´ ë¶„ìœ„ê¸°/í”¼ë“œë°± ë¶€ì¡±' },
            { id: 'advanced1', label: 'ì‹¬í™”ê³¼ì •ì´ í•„ìš”í•´ì„œ' },
            { id: 'advanced2', label: 'ì„ í–‰ê³¼ì •ì´ í•„ìš”í•´ì„œ' }
        ];

        const dispositionQuestions = [
            { id: 'cog1', type: 'cognitive', scorePos: 'a', a: 'ê³µì‹ì´ ìœ ë„ë˜ëŠ” ê³¼ì •ì„ ì´í•´í•˜ë ¤ê³  í•´ìš”', b: 'ê³µì‹ ì™¸ì›Œì„œ ë¬¸ì œì— ì ìš©í•˜ëŠ” ê²Œ í¸í•´ìš”' },
            { id: 'cog2', type: 'cognitive', scorePos: 'a', a: 'ì™œ ê·¸ë ‡ê²Œ ë˜ëŠ”ì§€ ì„¤ëª…í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”', b: 'ë‹µë§Œ ë§ìœ¼ë©´ êµ³ì´ ì„¤ëª…í•˜ë ¤ í•˜ì§€ ì•Šì•„ìš”' },
            { id: 'cog3', type: 'cognitive', scorePos: 'b', a: 'ìƒˆë¡œìš´ ê°œë…ì„ ë°°ìš¸ ë•Œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë ¤ìš”', b: 'ìƒˆë¡œìš´ ë‚´ìš©ì„ ë¹¨ë¦¬ ì´í•´í•˜ëŠ” í¸ì´ì—ìš”' },
            { id: 'cog4', type: 'cognitive', scorePos: 'a', a: 'ê¸€ì´ ë§ì€ ë¬¸ì œë„ ì°¨ê·¼ì°¨ê·¼ ì½ì–´ìš”', b: 'ë¬¸ì œê°€ ê¸¸ë©´ ì½ê¸° ì‹«ê³  ëŒ€ì¶© ì½ì–´ìš”' },
            { id: 'sol1', type: 'solving', scorePos: 'a', a: 'í’€ì´ ê³¼ì •ì„ ë…¸íŠ¸ì— ê¼¼ê¼¼íˆ ì ì–´ìš”', b: 'ì—°ìŠµì¥ ì—¬ê¸°ì €ê¸°ì— ì•”ì‚°ìœ¼ë¡œ í’€ì–´ìš”' },
            { id: 'sol2', type: 'solving', scorePos: 'b', a: 'ê³„ì‚° ì‹¤ìˆ˜ê°€ ì¦ì•„ì„œ ì ìˆ˜ê°€ ê¹ì—¬ìš”', b: 'ê³„ì‚°ì€ ì •í™•í•˜ê³  ê²€ì‚°ë„ í•˜ëŠ” í¸ì´ì—ìš”' },
            { id: 'sol3', type: 'solving', scorePos: 'a', a: 'ëª¨ë¥´ëŠ” ë¬¸ì œëŠ” í•´ì„¤ì§€ ë³´ê¸° ì „ì— ê³ ë¯¼í•´ìš”', b: 'ëª¨ë¥´ë©´ ë°”ë¡œ í•´ì„¤ì§€ë¥¼ ë³´ê±°ë‚˜ ì§ˆë¬¸í•´ìš”' },
            { id: 'sol4', type: 'solving', scorePos: 'a', a: 'ë¬¸ì œê°€ ì•ˆ í’€ë¦¬ë©´ ê·¸ë¦¼ì´ë‚˜ í‘œë¥¼ ê·¸ë ¤ë´ìš”', b: 'ë°°ìš´ ê³µì‹ì´ ìƒê° ì•ˆ ë‚˜ë©´ í¬ê¸°í•´ìš”' },
            { id: 'hab1', type: 'habit', scorePos: 'a', a: 'í•œ ë²ˆ ì•‰ìœ¼ë©´ 1ì‹œê°„ ì´ìƒ ì§‘ì¤‘í•´ìš”', b: 'ì¡°ê¸ˆ ê³µë¶€í•˜ë‹¤ê°€ ìê¾¸ ë”´ì§“ì„ í•´ìš”' },
            { id: 'hab2', type: 'habit', scorePos: 'a', a: 'ë§¤ì¼ ì •í•´ì§„ ë¶„ëŸ‰ì˜ ìˆ™ì œëŠ” ê¼­ í•´ìš”', b: 'ìˆ™ì œë¥¼ ëª°ì•„ì„œ í•˜ê±°ë‚˜ ìì£¼ ë°€ë ¤ìš”' },
            { id: 'hab3', type: 'habit', scorePos: 'a', a: 'í‹€ë¦° ë¬¸ì œëŠ” ì˜¤ë‹µ ë…¸íŠ¸ì— ë‹¤ì‹œ í’€ì–´ìš”', b: 'í‹€ë¦° ê±´ ëŒ€ì¶© ê³ ì¹˜ê³  ë„˜ì–´ê°€ìš”' },
            { id: 'hab4', type: 'habit', scorePos: 'a', a: 'ì‹œí—˜ ê¸°ê°„ì— ê³„íšì„ ì„¸ì›Œì„œ ê³µë¶€í•´ìš”', b: 'ê¸°ë¶„ì´ë‚˜ ìƒí™©ì— ë”°ë¼ ë‹¥ì¹˜ëŠ” ëŒ€ë¡œ í•´ìš”' },
            { id: 'aff1', type: 'affect', scorePos: 'a', a: 'ì–´ë ¤ìš´ ì‹¬í™” ë¬¸ì œë¥¼ í‘¸ëŠ” ê²Œ ì¬ë¯¸ìˆì–´ìš”', b: 'ì–´ë ¤ìš´ ë¬¸ì œëŠ” í”¼í•˜ê³  ì‰¬ìš´ ê²ƒë§Œ í’€ë˜ìš”' },
            { id: 'aff2', type: 'affect', scorePos: 'a', a: 'ìˆ˜í•™ ì ìˆ˜ê°€ ì‹¤ë ¥ë§Œí¼ ë‚˜ì˜¤ëŠ” í¸ì´ì—ìš”', b: 'ì‹¤ë ¥ì— ë¹„í•´ ì‹œí—˜ì„ ëª» ë³´ëŠ” í¸ì´ì—ìš”' },
            { id: 'aff3', type: 'affect', scorePos: 'a', a: 'ì§€ê¸ˆ ê³¼ì •ì„ ì™„ë²½í•˜ê²Œ ë‹¤ì§€ëŠ” ê²Œ ì¤‘ìš”í•´ìš”', b: 'ì¼ë‹¨ ì§„ë„ë¥¼ ë¹¨ë¦¬ ë‚˜ê°€ëŠ” ê²Œ ì¤‘ìš”í•´ìš”' },
            { id: 'aff4', type: 'affect', scorePos: 'a', a: 'ìˆ˜í•™ì€ ìƒê°í•˜ëŠ” í˜ì„ ê¸¸ëŸ¬ì¤˜ì„œ ì¢‹ì•„ìš”', b: 'ìˆ˜í•™ì€ ì…ì‹œ ë•Œë¬¸ì— ì–´ì©” ìˆ˜ ì—†ì´ í•´ìš”' }
        ];

        const state = {
            step: 0, totalSteps: 5, isSubmitting: false,
            data: {
                studentName: '', schoolType: '', schoolName: '', schoolGrade: '', parentPhone: '', studentPhone: '',
                learningMethod: '', moveReasons: [], moveReasonOther: '', currentBook: '',
                disposition: {}, generatedAnalysis: '',
                consultPath: 'parent_first', // Default
                testDate: '', testTimes: [],
                consultDate: '', consultTimes: [],
                timeOther: '', goal: ''
            }
        };

        const container = document.getElementById('step-content');
        const btnNext = document.getElementById('btn-next');
        const btnPrev = document.getElementById('btn-prev');
        const progressBar = document.getElementById('progress-bar');

        function getLocalTodayStr() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localDate = new Date(now - offset);
            return localDate.toISOString().split('T')[0];
        }

        function updateProgress() { progressBar.style.width = `${(state.step / state.totalSteps) * 100}%`; }

        function renderStep() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            container.innerHTML = '';
            container.className = 'p-6 sm:p-10 flex-grow flex flex-col relative fade-in';
            updateProgress();

            btnPrev.classList.toggle('hidden', state.step === 0);

            let nextText = 'ë‹¤ìŒ';
            if (state.step === 0) nextText = 'ìƒë‹´ì‹ ì²­ì„œ ì‘ì„±í•˜ê¸°';
            if (state.step === state.totalSteps) nextText = 'ì˜ˆì•½ ì™„ë£Œí•˜ê¸°';
            btnNext.innerHTML = `<span>${nextText}</span>`;

            if (state.step === state.totalSteps + 1) { btnNext.classList.add('hidden'); btnPrev.classList.add('hidden'); }
            else { btnNext.classList.remove('hidden'); }

            // [Order] 1.Intro -> 2.History -> 3.Disposition -> 4.Scheduling -> 5.BasicInfo -> 6.Summary -> 7.Success
            switch (state.step) {
                case 0: renderLanding(); break;
                case 1: renderHistory(); break;
                case 2: renderDisposition(); break;
                case 3: renderScheduling(); break;
                case 4: renderBasicInfo(); break;
                case 5: renderSummary(); break;
                case 6: renderSuccess(); break;
            }
        }

        function renderLanding() {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 my-auto">
                    <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-4xl mb-4">ğŸ“Š</div>
                    <h2 class="text-3xl font-bold text-stone-800">1:1 ì‹¬ì¸µ ìƒë‹´ ì‚¬ì „ ì§„ë‹¨</h2>
                    <p class="text-stone-600 text-lg max-w-lg leading-relaxed">ì•ˆë…•í•˜ì„¸ìš”, ì¹´ì´ìŠ¤íŠ¸ìˆ˜í•™í•™ì›ì…ë‹ˆë‹¤.<br>í•™ìƒì˜ í˜„ì¬ í•™ìŠµ ìƒí™©ì„ ë¯¸ë¦¬ íŒŒì•…í•˜ì—¬,<br>ë‚´ë°© ì‹œ <strong>ê°€ì¥ ì‹¤ì§ˆì ì¸ ì†”ë£¨ì…˜</strong>ì„ ë“œë¦¬ê¸° ìœ„í•œ ê³¼ì •ì…ë‹ˆë‹¤.</p>
                    <div class="bg-stone-50 p-6 rounded-xl border border-stone-200 text-left w-full max-w-md">
                        <ul class="space-y-3 text-stone-600 text-sm">
                            <li class="flex items-center"><span class="mr-3 text-indigo-500">âœ“</span> 1. í˜„ì¬ í•™ìŠµ ë°©ë²• ë° ê³ ë¯¼ ì§„ë‹¨</li>
                            <li class="flex items-center"><span class="mr-3 text-indigo-500">âœ“</span> 2. í•™ìŠµ ì„±í–¥ ë¶„ì„ (ì •ë°€)</li>
                            <li class="flex items-center"><span class="mr-3 text-indigo-500">âœ“</span> 3. ì…í•™í…ŒìŠ¤íŠ¸ ë° ìƒë‹´ ì˜ˆì•½</li>
                            <li class="flex items-center"><span class="mr-3 text-indigo-500">âœ“</span> 4. ê¸°ë³¸ ì¸ì  ì‚¬í•­ í™•ì¸</li>
                        </ul>
                    </div>
                </div>`;
        }

        function renderBasicInfo() {
            container.innerHTML = `
                <div class="space-y-6">
                    <div><h2 class="text-2xl font-bold text-stone-800 mb-2">í•™ìƒ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</h2><p class="text-stone-500 text-sm">ì›í™œí•œ ìƒë‹´ì„ ìœ„í•´ ì •í™•í•œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p></div>
                    <div class="grid grid-cols-1 gap-5">
                        <div><label class="block text-sm font-bold text-stone-700 mb-1">í•™ìƒ ì´ë¦„ <span class="text-red-500">*</span></label><input type="text" id="input-name" value="${state.data.studentName}" class="w-full px-4 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: ê¹€ìˆ˜í•™"></div>
                        <div>
                            <label class="block text-sm font-bold text-stone-700 mb-1">í•™êµ ë° í•™ë…„ <span class="text-red-500">*</span></label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="sel-school-type" class="px-2 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 text-sm bg-white" onchange="updateSchoolList()">
                                    <option value="">í•™êµê¸‰</option>
                                    <option value="elementary" ${state.data.schoolType === 'elementary' ? 'selected' : ''}>ì´ˆë“±í•™ìƒ</option>
                                    <option value="middle" ${state.data.schoolType === 'middle' ? 'selected' : ''}>ì¤‘í•™ìƒ</option>
                                    <option value="high" ${state.data.schoolType === 'high' ? 'selected' : ''}>ê³ ë“±í•™ìƒ</option>
                                </select>
                                <select id="sel-school-name" class="px-2 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 text-sm bg-white" onchange="checkManualSchool()">
                                    <option value="">í•™êµ ì„ íƒ</option>
                                </select>
                                <select id="sel-grade" class="px-2 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 text-sm bg-white">
                                    <option value="">í•™ë…„</option>
                                </select>
                            </div>
                            <input type="text" id="input-school-manual" class="w-full mt-2 px-4 py-2 rounded-lg border border-stone-300 text-sm hidden" placeholder="í•™êµëª… ì§ì ‘ ì…ë ¥" value="${state.data.schoolName}">
                        </div>
                        <div><label class="block text-sm font-bold text-stone-700 mb-1">í•™ë¶€ëª¨ë‹˜ ì—°ë½ì²˜ <span class="text-red-500">*</span></label><input type="tel" id="input-parent-phone" value="${state.data.parentPhone}" class="w-full px-4 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="010-0000-0000"></div>
                        <div><label class="block text-sm font-bold text-stone-700 mb-1">í•™ìƒ ì—°ë½ì²˜ <span class="text-stone-400 font-normal">(ì„ íƒ)</span></label><input type="tel" id="input-student-phone" value="${state.data.studentPhone}" class="w-full px-4 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="í•™ìƒì´ ì§ì ‘ ë“±ì› ì‹œ ì…ë ¥"></div>
                    </div>
                </div>`;
            document.getElementById('input-name').addEventListener('input', (e) => state.data.studentName = e.target.value);
            document.getElementById('input-parent-phone').addEventListener('input', (e) => state.data.parentPhone = e.target.value);
            document.getElementById('input-student-phone').addEventListener('input', (e) => state.data.studentPhone = e.target.value);
            document.getElementById('sel-grade').addEventListener('change', (e) => state.data.schoolGrade = e.target.value);
            document.getElementById('input-school-manual').addEventListener('input', (e) => state.data.schoolName = e.target.value);

            updateSchoolList();
            if (state.data.schoolType) {
                document.getElementById('sel-school-type').value = state.data.schoolType;
                updateSchoolList();
                const selName = document.getElementById('sel-school-name');
                if ([...selName.options].some(o => o.value === state.data.schoolName)) selName.value = state.data.schoolName;
                else if (state.data.schoolName) { selName.value = 'ì§ì ‘ì…ë ¥'; checkManualSchool(); }
                const selGrade = document.getElementById('sel-grade');
                if ([...selGrade.options].some(o => o.value === state.data.schoolGrade)) selGrade.value = state.data.schoolGrade;
            }
        }

        function renderHistory() {
            container.innerHTML = `
                <div class="space-y-6 h-full overflow-y-auto">
                    <div><h2 class="text-2xl font-bold text-stone-800 mb-2">í•™ìŠµ ì´ë ¥ í™•ì¸</h2><p class="text-stone-500 text-sm">í˜„ì¬ í•™ìŠµ ìƒí™©ì„ ì •í™•í•˜ê²Œ ì•Œë ¤ì£¼ì„¸ìš”.</p></div>
                    <div>
                        <label class="block text-sm font-bold text-stone-700 mb-3">í˜„ì¬ ìˆ˜í•™ í•™ìŠµ ë°©ë²• <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-3">
                            ${learningMethods.map(m => `
                                <div onclick="selectMethod('${m.id}')" 
                                     class="option-card cursor-pointer p-4 rounded-xl border ${state.data.learningMethod === m.id ? 'border-indigo-600 bg-indigo-50 ring-1 ring-indigo-600' : 'border-stone-200 hover:border-indigo-300'} transition flex items-center space-x-3">
                                    <div class="text-xl">${m.icon}</div>
                                    <div class="text-sm font-medium ${state.data.learningMethod === m.id ? 'text-indigo-700' : 'text-stone-600'}">${m.label}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div id="reason-section" class="pt-4 ${state.data.learningMethod === 'none' ? 'opacity-50 pointer-events-none' : ''}"><label class="block text-sm font-bold text-stone-700 mb-3">í•™ì›ì„ ì˜®ê¸°ê±°ë‚˜ ìƒˆë¡œ ë‹¤ë‹ˆë ¤ëŠ” ì´ìœ  <span class="text-stone-400 font-normal">(ì¤‘ë³µ ê°€ëŠ¥)</span></label><div class="space-y-2">${moveReasons.map(r => `<div onclick="toggleReason('${r.id}')" class="cursor-pointer p-3 rounded-lg border ${state.data.moveReasons.includes(r.id) ? 'border-indigo-600 bg-indigo-50' : 'border-stone-200 hover:bg-stone-50'} transition flex items-center"><div class="w-5 h-5 rounded border ${state.data.moveReasons.includes(r.id) ? 'bg-indigo-600 border-indigo-600' : 'border-stone-300'} flex items-center justify-center mr-3 transition flex-shrink-0">${state.data.moveReasons.includes(r.id) ? '<span class="text-white text-xs">âœ“</span>' : ''}</div><span class="text-sm text-stone-700">${r.label}</span></div>`).join('')}<div class="p-3 rounded-lg border border-stone-200 bg-stone-50"><input type="text" id="reason-other" value="${state.data.moveReasonOther}" class="w-full bg-transparent outline-none text-sm placeholder-stone-400" placeholder="ìœ„ í•­ëª© ì™¸ì—ë„ ë‹¤ë¥¸ ì´ìœ ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€í•´ ì£¼ì„¸ìš”." oninput="state.data.moveReasonOther = this.value"></div></div></div>
                    <div class="pt-4"><label class="block text-sm font-bold text-stone-700 mb-2">í˜„ì¬ êµì¬ ë° ì§„ë„ ìƒí™©</label><textarea id="input-book" rows="2" class="w-full px-4 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 outline-none text-sm" placeholder="ì˜ˆ: ìˆ ì¤‘2-1 ëëƒ„, ê°œë…í”ŒëŸ¬ìŠ¤ìœ í˜• ê³µí†µìˆ˜í•™1(ìƒ) ì´ì°¨í•¨ìˆ˜ ì§„í–‰ ì¤‘">${state.data.currentBook}</textarea></div>
                </div>`;
            document.getElementById('input-book').addEventListener('input', (e) => state.data.currentBook = e.target.value);
        }

        function renderDisposition() {
            container.innerHTML = `
                <div class="space-y-6 h-full overflow-y-auto">
                    <div><h2 class="text-2xl font-bold text-stone-800 mb-2">í•™ìŠµ ì„±í–¥ ì§„ë‹¨ (KAIST ëª¨ë¸)</h2><p class="text-stone-500 text-sm">í•™ìƒì—ê²Œ ë” ê°€ê¹Œìš´ ìª½ì„ ì„ íƒí•´ì£¼ì„¸ìš”. <span class="text-indigo-600 font-bold">(ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.)</span><br>ì •í™•í•œ ì§„ë‹¨ì„ ìœ„í•´ í˜„ì¬ ìƒí™©ì„ ìˆëŠ” ê·¸ëŒ€ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.</p></div>
                    <div class="space-y-4 pb-4">
                        ${dispositionQuestions.map((q, idx) => `
                            <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <button onclick="selectDisposition('${q.id}', 'A')" 
                                        class="flex-1 p-3 border rounded-lg text-left text-sm transition-all ${state.data.disposition[q.id] === 'A' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-50'}">
                                        ${q.a}
                                    </button>
                                    <button onclick="selectDisposition('${q.id}', 'B')" 
                                        class="flex-1 p-3 border rounded-lg text-left text-sm transition-all ${state.data.disposition[q.id] === 'B' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-50'}">
                                        ${q.b}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderScheduling() {
            if (!state.data.consultPath) state.data.consultPath = 'parent_first';

            const isActive = (path) => state.data.consultPath === path ? 'border-indigo-600 bg-indigo-50 text-indigo-700 ring-1 ring-indigo-600' : 'border-stone-200 text-stone-500 hover:bg-stone-50';
            const today = getLocalTodayStr();
            const maxDate = new Date(); maxDate.setDate(maxDate.getDate() + 14); const maxDateStr = maxDate.toISOString().split('T')[0];

            let guideText = '';
            if (state.data.consultPath === 'parent_first') {
                guideText = 'í•™ë¶€ëª¨ë‹˜ê»˜ì„œ ë¨¼ì € ë‚´ë°©í•˜ì…”ì„œ ìƒë‹´ í›„ í•™ìƒ í…ŒìŠ¤íŠ¸ ì¼ì •ì„ ê²°ì •í•©ë‹ˆë‹¤.';
            } else if (state.data.consultPath === 'student_first') {
                guideText = 'í•™ìƒì´ ë¨¼ì € ì…í•™í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê³ , ì¶”í›„ í•™ë¶€ëª¨ë‹˜ê»˜ì„œ ë‚´ë°©í•˜ì‹­ë‹ˆë‹¤.';
            } else {
                guideText = 'í•™ìƒê³¼ í•™ë¶€ëª¨ë‹˜ì´ í•¨ê»˜ ë‚´ë°©í•˜ì—¬ í…ŒìŠ¤íŠ¸ì™€ ìƒë‹´ì„ ì§„í–‰í•©ë‹ˆë‹¤.';
            }

            const times = ['14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];

            // Helper to generate schedule block
            const createScheduleBlock = (title, dateKey, timeKey, dateVal, timeVals, onDateChange, onTimeToggle, minDate) => `
                <div class="bg-white border border-stone-200 rounded-xl p-4 shadow-sm mb-4">
                    <label class="block text-sm font-bold text-stone-700 mb-2">${title}</label>
                    <div class="flex flex-col space-y-3">
                        <input type="date" onchange="${onDateChange}(this.value)" min="${minDate}" max="${maxDateStr}" value="${dateVal}" class="w-full px-3 py-2 border rounded-lg text-sm bg-white">
                        <div class="grid grid-cols-4 gap-2">
                            ${times.map(t => `
                                <button onclick="${onTimeToggle}('${t}')" 
                                    class="py-2 rounded border text-xs font-medium transition-colors ${timeVals.includes(t) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-50'}">
                                    ${t}
                                </button>
                            `).join('')}
                        </div>
                        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-100 text-xs text-indigo-600 font-medium">
                            <p>ğŸ’¡ ê°€ëŠ¥í•˜ì‹  ì¼ì •ì„ ì¤‘ë³µí•˜ì—¬ ì„ íƒí•´ ì£¼ì„¸ìš”. ì¶”í›„ í•™ì› ì¼ì •ê³¼ ì¡°ìœ¨í•˜ì—¬ ë°©ë¬¸ì¼ì •ì„ í™•ì •í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            `;

            let scheduleHtml = '';

            if (state.data.consultPath === 'student_first') {
                // Dual scheduling
                scheduleHtml += createScheduleBlock('1. í•™ìƒ í…ŒìŠ¤íŠ¸ í¬ë§ ì¼ì •', 'testDate', 'testTimes', state.data.testDate, state.data.testTimes, 'setTestDate', 'toggleTestTime', today);

                // 2. Parent Consult (Must be >= Student Test Date)
                const consultMinDate = state.data.testDate ? state.data.testDate : today;
                scheduleHtml += createScheduleBlock('2. í•™ë¶€ëª¨ë‹˜ ìƒë‹´ í¬ë§ ì¼ì •', 'consultDate', 'consultTimes', state.data.consultDate, state.data.consultTimes, 'setConsultDate', 'toggleConsultTime', consultMinDate);
            } else {
                // Single scheduling (Parent First or Together)
                const label = state.data.consultPath === 'parent_first' ? 'í•™ë¶€ëª¨ë‹˜ ìƒë‹´ í¬ë§ ì¼ì •' : 'ë°©ë¬¸ í¬ë§ ì¼ì • (í…ŒìŠ¤íŠ¸+ìƒë‹´)';
                scheduleHtml += createScheduleBlock(label, 'consultDate', 'consultTimes', state.data.consultDate, state.data.consultTimes, 'setConsultDate', 'toggleConsultTime', today);
            }

            container.innerHTML = `
                <div class="space-y-6 h-full overflow-y-auto pb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-stone-800 mb-2">ì…í•™í…ŒìŠ¤íŠ¸ ë° ìƒë‹´ ì˜ˆì•½</h2>
                        <div class="bg-indigo-50 p-4 rounded-lg text-xs text-indigo-900 leading-relaxed space-y-1">
                            <p><strong>[ì•ˆë‚´]</strong> ${guideText}</p>
                            <p>â€¢ ì…í•™í…ŒìŠ¤íŠ¸ ì†Œìš”ì‹œê°„: ì•½ 50ë¶„ (í•™êµ ì‹œí—˜ ë‚œì´ë„)</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setConsultPath('parent_first')" class="p-3 rounded-xl border text-sm font-bold transition-all ${isActive('parent_first')}">
                            í•™ë¶€ëª¨ë‹˜ ë¨¼ì € ë‚´ë°©<br><span class="font-normal text-xs text-stone-400">ìƒë‹´ í›„ í•™ìƒ í…ŒìŠ¤íŠ¸ ì¼ì • ê²°ì •</span>
                        </button>
                        <button onclick="setConsultPath('student_first')" class="p-3 rounded-xl border text-sm font-bold transition-all ${isActive('student_first')}">
                            í•™ìƒ ë¨¼ì € í…ŒìŠ¤íŠ¸<br><span class="font-normal text-xs text-stone-400">í›„ í•™ë¶€ëª¨ë‹˜ ë‚´ë°©</span>
                        </button>
                        <button onclick="setConsultPath('together')" class="p-3 rounded-xl border text-sm font-bold transition-all ${isActive('together')}">
                            í•™ìƒê³¼ í•¨ê»˜ ë‚´ë°©<br><span class="font-normal text-xs text-stone-400">í…ŒìŠ¤íŠ¸+ìƒë‹´ ë‹¹ì¼</span>
                        </button>
                    </div>

                    ${scheduleHtml}

                    <div><label class="block text-sm font-bold text-stone-700 mb-2"> í•™ì›ì—ì„œ ê¼­ í•´ê²°í•˜ê¸¸ í¬ë§í•˜ëŠ” ì </label><textarea id="input-goal" rows="2" class="w-full px-4 py-3 rounded-lg border border-stone-300 focus:ring-2 focus:ring-indigo-500 outline-none text-sm" placeholder="ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”.">${state.data.goal}</textarea></div>
                </div>`;

            const goalInput = document.getElementById('input-goal');
            if (goalInput) goalInput.addEventListener('input', (e) => state.data.goal = e.target.value);
        }

        function renderSummary() {
            state.data.generatedAnalysis = generateAnalysis(state.data.disposition);
            container.innerHTML = `
                <div class="space-y-6 h-full overflow-y-auto">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold text-stone-800">ì…ë ¥ ë‚´ìš© í™•ì¸</h2><p class="text-stone-500 text-sm">ì‘ì„±í•´ì£¼ì‹  ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>
                    <div class="bg-white rounded-xl border border-stone-200 divide-y divide-stone-100 shadow-sm">
                        <div class="p-5"><span class="block text-xs text-stone-400 font-bold mb-1">í•™ìƒ ì •ë³´</span><div class="text-stone-800 font-medium text-lg">${state.data.studentName}</div><div class="text-stone-600 text-sm">${state.data.schoolName || '-'} (${state.data.schoolGrade || '-'})</div><div class="text-stone-600 text-sm mt-1">ë¶€ëª¨ë‹˜: ${state.data.parentPhone}</div></div>
                        <div class="p-5"><span class="block text-xs text-stone-400 font-bold mb-1">í•™ìŠµ ì´ë ¥ ë° ê³ ë¯¼</span><div class="text-stone-700 text-sm mb-1">í˜„ì¬: ${getLearningMethodLabel(state.data.learningMethod)}</div><div class="text-stone-700 text-sm mb-1">êµì¬: ${state.data.currentBook || '-'}</div><div class="flex flex-wrap gap-1 mt-2">${state.data.moveReasons.map(id => `<span class="bg-stone-100 text-stone-600 px-2 py-1 rounded text-xs">${moveReasons.find(r => r.id === id)?.label || id}</span>`).join('')}${state.data.moveReasonOther ? `<span class="bg-stone-100 text-stone-600 px-2 py-1 rounded text-xs">${state.data.moveReasonOther}</span>` : ''}</div></div>
                        <div class="p-5"><span class="block text-xs text-stone-400 font-bold mb-1">í•™ì›ì—ì„œ ê¼­ í•´ê²°í•˜ê¸¸ í¬ë§í•˜ëŠ” ì </span><div class="text-stone-700 text-sm bg-stone-50 p-3 rounded-lg leading-relaxed">${state.data.goal || 'ì‘ì„±ëœ ë‚´ìš© ì—†ìŒ'}</div></div>
                        <div class="p-5 bg-indigo-50"><span class="block text-xs text-indigo-400 font-bold mb-1">ì˜ˆì•½ í¬ë§ ì¼ì •</span><div class="text-indigo-900 text-sm font-bold whitespace-pre-line">${getScheduleSummaryHTML()}</div><div class="text-xs text-indigo-400 mt-2">* í•™ì›ì—ì„œ 1~2ì¼ ì´ë‚´ì— ì „í™”ë¥¼ ë“œë ¤ í•™ì› ì¼ì •ê³¼ ì¡°ìœ¨í•˜ì—¬ ìµœì¢… ì¼ì •ì„ í™•ì •í•©ë‹ˆë‹¤.</div></div>
                    </div>
                </div>`;
        }

        function closeWindow() {
            try { window.open('', '_self').close(); } catch (e) { }
            try { window.close(); } catch (e) { }
            showAlert("ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì •ìœ¼ë¡œ ì¸í•´ ì°½ì´ ë‹«íˆì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ ë‹«ê¸°(X) ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ë£Œí•´ ì£¼ì„¸ìš”.");
        }

        function renderSuccess() {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-6 my-auto fade-in">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-4xl mb-4 text-green-600">âœ…</div>
                    <h2 class="text-3xl font-bold text-stone-800">ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ!</h2>
                    <p class="text-stone-600 text-lg max-w-lg leading-relaxed">ì¹´ì´ìŠ¤íŠ¸ìˆ˜í•™í•™ì› ìƒë‹´ì‹ ì²­ì„œë¥¼ ì‘ì„±í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>ë‚¨ê²¨ì£¼ì‹  <strong>${state.data.parentPhone}</strong> ë²ˆí˜¸ë¡œ<br>ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>
                    <div class="pt-6"><button onclick="closeWindow()" class="text-indigo-600 underline text-sm hover:text-indigo-800 block mt-4">ì°½ ë‹«ê¸°</button></div>
                </div>`;
        }

        // --- Logic Helpers ---
        function updateSchoolList() {
            const type = document.getElementById('sel-school-type').value;
            state.data.schoolType = type;
            const nameSelect = document.getElementById('sel-school-name');
            const gradeSelect = document.getElementById('sel-grade');
            nameSelect.innerHTML = '<option value="">í•™êµ ì„ íƒ</option>';
            gradeSelect.innerHTML = '<option value="">í•™ë…„</option>';
            if (type && schoolsData[type]) { schoolsData[type].forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; nameSelect.appendChild(opt); }); }

            if (type === 'elementary') {
                ['ì´ˆ6(ì˜ˆë¹„ì¤‘1)'].forEach(g => { const opt = document.createElement('option'); opt.value = g; opt.text = g; gradeSelect.appendChild(opt); });
            } else if (type === 'middle' || type === 'high') {
                ['1í•™ë…„', '2í•™ë…„', '3í•™ë…„'].forEach(g => { const opt = document.createElement('option'); opt.value = g; opt.text = g; gradeSelect.appendChild(opt); });
            }
            checkManualSchool();
        }
        function checkManualSchool() {
            const val = document.getElementById('sel-school-name').value;
            const manual = document.getElementById('input-school-manual');
            if (val === 'ì§ì ‘ì…ë ¥') { manual.classList.remove('hidden'); state.data.schoolName = manual.value; }
            else { manual.classList.add('hidden'); state.data.schoolName = val; }
        }

        // Scheduling Logic
        function setConsultPath(path) {
            state.data.consultPath = path;
            // Reset dates on path change
            state.data.testDate = ''; state.data.testTimes = [];
            state.data.consultDate = ''; state.data.consultTimes = [];
            renderScheduling();
        }

        // Test Schedule Helpers
        window.setTestDate = (val) => {

            state.data.testDate = val;
            state.data.testTimes = [];

            // If Student First, reset consult date if it's earlier than test date
            if (state.data.consultPath === 'student_first' && state.data.consultDate && state.data.consultDate < val) {
                state.data.consultDate = '';
                state.data.consultTimes = [];
                showAlert('í•™ë¶€ëª¨ë‹˜ ìƒë‹´ ì¼ì •ì€ í•™ìƒ í…ŒìŠ¤íŠ¸ ì¼ì • ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤. ìƒë‹´ ì¼ì •ì„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            }
            renderScheduling();
        };
        window.toggleTestTime = (time) => {
            const idx = state.data.testTimes.indexOf(time);
            if (idx === -1) state.data.testTimes.push(time); else state.data.testTimes.splice(idx, 1);
            renderScheduling();
        };

        // Consult Schedule Helpers
        window.setConsultDate = (val) => { state.data.consultDate = val; state.data.consultTimes = []; renderScheduling(); };
        window.toggleConsultTime = (time) => {
            const idx = state.data.consultTimes.indexOf(time);
            if (idx === -1) state.data.consultTimes.push(time); else state.data.consultTimes.splice(idx, 1);
            renderScheduling();
        };

        function getScheduleSummaryHTML() {
            const path = state.data.consultPath;
            let summary = '';

            if (path === 'student_first') {
                if (state.data.testDate) summary += `[í•™ìƒ í…ŒìŠ¤íŠ¸] ${state.data.testDate} (${state.data.testTimes.join(', ') || 'ì‹œê°„ ë¯¸ì„ íƒ'})\n`;
                if (state.data.consultDate) summary += `[í•™ë¶€ëª¨ ìƒë‹´] ${state.data.consultDate} (${state.data.consultTimes.join(', ') || 'ì‹œê°„ ë¯¸ì„ íƒ'})`;
            } else {
                const label = path === 'parent_first' ? 'í•™ë¶€ëª¨ ìƒë‹´' : 'ë™ë°˜ ìƒë‹´/í…ŒìŠ¤íŠ¸';
                if (state.data.consultDate) summary += `[${label}] ${state.data.consultDate} (${state.data.consultTimes.join(', ') || 'ì‹œê°„ ë¯¸ì„ íƒ'})`;
            }
            return summary || 'ì¼ì • ë¯¸ì„ íƒ';
        }

        // --- Analysis ---
        function generateAnalysis(d) {
            let scores = { cognitive: 0, habit: 0, affect: 0, solving: 0 };
            for (const [qId, selectedVal] of Object.entries(d)) {
                const q = dispositionQuestions.find(q => q.id === qId);
                if (q && q.scorePos === selectedVal.toLowerCase()) scores[q.type]++;
            }
            const getBar = (val, max) => { const percent = (val / max) * 10; let bar = ''; for (let i = 0; i < 5; i++) bar += (i < percent / 2) ? 'â– ' : 'â–¡'; return bar; };
            let report = `[KAIST ìˆ˜í•™ ì •ë°€ ì§„ë‹¨ ë¦¬í¬íŠ¸]\n\n1. ì˜ì—­ë³„ ì§„ë‹¨ (4ì  ë§Œì )\nì¸ì§€íš¨ìœ¨: ${getBar(scores.cognitive, 4)} (${scores.cognitive}ì )\në¬¸ì œí•´ê²°: ${getBar(scores.solving, 4)} (${scores.solving}ì )\ní•™ìŠµì§‘ìš”í•¨: ${getBar(scores.habit, 4)} (${scores.habit}ì )\nìˆ˜í•™ì •ì„œ: ${getBar(scores.affect, 4)} (${scores.affect}ì )\n\n2. ì˜ì—­ë³„ ìƒì„¸ ë¶„ì„\n`;

            report += `- [ì¸ì§€] `;
            if (scores.cognitive <= 1) report += "ê°œë… ìŠµë“ ì†ë„ê°€ ë‹¤ì†Œ ëŠ¦ê±°ë‚˜ í”¼ìƒì ìœ¼ë¡œ ì´í•´í•˜ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. 'ë°±ì§€ ë³µìŠµ' í›ˆë ¨ì´ í•„ìš”í•©ë‹ˆë‹¤.\n";
            else if (scores.cognitive <= 3) report += "ì´í•´ë„ëŠ” ì–‘í˜¸í•˜ë‚˜ ë³µí•© ê°œë… ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. ì‹¬í™” ê°œë… í•™ìŠµì„ ì¶”ì²œí•©ë‹ˆë‹¤.\n";
            else report += "ìˆ˜í•™ì  ë¬¸í•´ë ¥ê³¼ ì§ê´€ë ¥ì´ ë§¤ìš° ë›°ì–´ë‚©ë‹ˆë‹¤.\n";
            report += `- [í•´ê²°] `;
            if (scores.solving <= 1) report += "ì•„ëŠ” ê²ƒê³¼ í‘¸ëŠ” ê²ƒì˜ ì°¨ì´ê°€ í½ë‹ˆë‹¤. ì„œìˆ í˜• í›ˆë ¨ì´ ì‹œê¸‰í•©ë‹ˆë‹¤.\n";
            else if (scores.solving <= 3) report += "ê³„ì‚° ì‹¤ìˆ˜ë‚˜ ì¡°ê±´ ëˆ„ë½ì„ ì¤„ì´ëŠ” ê¼¼ê¼¼í•¨ì´ í•„ìš”í•©ë‹ˆë‹¤.\n";
            else report += "ë¬¸ì œ í•´ê²° ì „ëµì´ ìš°ìˆ˜í•˜ê³  ê³„ì‚°ì´ ì •í™•í•©ë‹ˆë‹¤.\n";
            report += `- [ìŠµê´€] `;
            if (scores.habit <= 1) report += "í•™ìŠµì˜ ì§€ì†ì„±ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì‘ì€ ìŠµê´€ë¶€í„° ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.\n";
            else if (scores.habit <= 3) report += "ê¸°ë³¸ íƒœë„ëŠ” ì¢‹ìœ¼ë‚˜ ì»¨ë””ì…˜ ê¸°ë³µ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n";
            else report += "ìê¸°ì£¼ë„ì  í•™ìŠµ ëŠ¥ë ¥ì´ íƒì›”í•©ë‹ˆë‹¤.\n";
            report += `- [ì •ì„œ] `;
            if (scores.affect <= 1) report += "ìˆ˜í•™ì— ëŒ€í•œ ë¶€ë‹´ê°ì´ í½ë‹ˆë‹¤. ì„±ê³µ ê²½í—˜ì´ í•„ìš”í•©ë‹ˆë‹¤.\n";
            else if (scores.affect <= 3) report += "ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ” ê²½í–¥ì´ ìˆì–´ ì ì ˆí•œ ì±Œë¦°ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n";
            else report += "ë„ì „ ì˜ì‹ì´ ë†’ê³  ì„±ì·¨ê°ì„ ì¦ê¸¸ ì¤„ ì•„ëŠ” ìƒíƒœì…ë‹ˆë‹¤.\n";
            report += `\n3. ì¢…í•© ì²˜ë°© ë° ë¡œë“œë§µ\n`;
            if (scores.habit <= 1 && scores.affect <= 1) report += "â–¶ [í¬ë§ ì½”ì¹­í˜•] 00ì´ê°€ ê·¸ë™ì•ˆ ìˆ˜í•™ ë•Œë¬¸ì— ë§ˆìŒê³ ìƒì´ ì¢€ ìˆì—ˆê² ì–´ìš”. í•˜ì§€ë§Œ ê´œì°®ìŠµë‹ˆë‹¤. ì§€ê¸ˆì€ ìˆ˜í•™ ì§€ì‹ì„ ê¸‰í•˜ê²Œ ë„£ê¸°ë³´ë‹¤ 'ë‚˜ë„ í•  ìˆ˜ ìˆë‹¤'ëŠ” ì‘ì€ ì„±ê³µ ê²½í—˜ì„ ë§›ë³´ëŠ” ê²Œ ì œì¼ ì¤‘ìš”í•´ìš”. ì €í¬ëŠ” 00ì´ê°€ ì†Œí™”í•  ìˆ˜ ìˆëŠ” ë¶„ëŸ‰ë¶€í„° ì‹œì‘í•´ì„œ, 'ì–´? ë§‰ìƒ í•´ë³´ë‹ˆê¹Œ í’€ë¦¬ë„¤?'ë¼ëŠ” ê¸°ë¶„ì„ ëŠë¼ê²Œ í•´ì¤„ ê²ë‹ˆë‹¤. ê³µë¶€ ì •ì„œê°€ ë°ì•„ì§€ë©´ ìŠµê´€ì€ ìì—°ìŠ¤ëŸ½ê²Œ ë”°ë¼ì˜¤ê±°ë“ ìš”. ì €í¬ê°€ 00ì´ì˜ ë“ ë“ í•œ í˜ì´ìŠ¤ë©”ì´ì»¤ê°€ ë˜ì–´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n";
            else if (scores.affect <= 1 && scores.cognitive >= 3 && scores.solving >= 3) report += "â–¶ [ë§ˆìŒ ì±™ê¹€í˜•] 00ì´ëŠ” ìˆ˜í•™ì  ì—­ëŸ‰ì´ ì •ë§ ë›°ì–´ë‚œ ì¹œêµ¬ì˜ˆìš”. ì–´ë ¤ìš´ ë¬¸ì œë„ ì²™ì²™ í•´ê²°í•  í˜ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ìµœê·¼ì— ì¡°ê¸ˆ ì§€ì¹˜ê±°ë‚˜ í¥ë¯¸ë¥¼ ìƒì€ ê²ƒ ê°™ì•„ìš”. ê¸°ê³„ì ì¸ ë¬¸ì œ í’€ì´ë³´ë‹¤ëŠ” 'ì´ê±¸ ì™œ ë°°ìš°ëŠ”ì§€', 'ì´ ì›ë¦¬ê°€ ì–¼ë§ˆë‚˜ ì¬ë°ŒëŠ”ì§€'ë¥¼ ì•Œê²Œ ë˜ë©´ ëˆˆë¹›ì´ ë‹¬ë¼ì§ˆ ì•„ì´ì…ë‹ˆë‹¤. ë‹¨ìˆœ ë°˜ë³µ í›ˆë ¨ì€ ì¤„ì´ê³ , 00ì´ì˜ í˜¸ê¸°ì‹¬ì„ ìê·¹í•˜ëŠ” ê¹Šì´ ìˆëŠ” ë©˜í† ë§ìœ¼ë¡œ ë‹¤ì‹œ ìˆ˜í•™ì˜ ì¦ê±°ì›€ì„ ì°¾ì•„ì£¼ê² ìŠµë‹ˆë‹¤.\n";
            else if (scores.affect <= 1) report += "â–¶ [ìì‹ ê° ì¶©ì „í˜•] 00ì´ëŠ” ì¶©ë¶„íˆ ì˜í•  ìˆ˜ ìˆëŠ” ì ì¬ë ¥ì´ ìˆëŠ”ë°, ìŠ¤ìŠ¤ë¡œë¥¼ ê³¼ì†Œí‰ê°€í•˜ê³  ìˆëŠ” ê²ƒ ê°™ì•„ ì•ˆíƒ€ê¹Œì›Œìš”. ì§€ê¸ˆ í•„ìš”í•œ ê±´ ì„ í–‰ ì§„ë„ê°€ ì•„ë‹ˆë¼ 'ìì¡´ê° íšŒë³µ'ì…ë‹ˆë‹¤. ì–´ë ¤ìš´ ë¬¸ì œë¡œ ê¸°ë¥¼ ì£½ì´ê¸°ë³´ë‹¤, 00ì´ ìˆ˜ì¤€ì— ë”± ë§ëŠ” ë¬¸ì œë“¤ë¡œ ë™ê·¸ë¼ë¯¸ê°€ ëŠ˜ì–´ë‚˜ëŠ” ì§œë¦¿í•¨ì„ ì„ ë¬¼í•´ì£¼ê³  ì‹¶ìŠµë‹ˆë‹¤. ìì‹ ê°ë§Œ ë¶™ìœ¼ë©´ ì„±ì ì€ ë¬´ì„­ê²Œ ì˜¤ë¥¼ ê±°ì˜ˆìš”. ë¯¿ê³  ë§¡ê²¨ì£¼ì„¸ìš”.\n";
            else if (scores.habit <= 1) report += "â–¶ [ë£¨í‹´ ì„¤ê³„í˜•] ì–´ë¨¸ë‹˜, 00ì´ëŠ” ì†Œìœ„ ë§í•˜ëŠ” 'ìˆ˜í•™ì  ë¨¸ë¦¬'ê°€ ìˆëŠ” ì¹œêµ¬ì…ë‹ˆë‹¤. í•˜ë‚˜ë¥¼ ê°€ë¥´ì¹˜ë©´ ì—´ì„ ì•Œ ì •ë„ë¡œ ìŠµë“ë ¥ì´ ì¢‹ì•„ìš”. ë‹¤ë§Œ, ê·¸ ì¢‹ì€ ë¨¸ë¦¬ë¥¼ ì§€íƒ±í•´ì¤„ 'í•™ìŠµ ìŠµê´€(ë£¨í‹´)'ì´ ì•„ì§ì€ ì¡°ê¸ˆ ì•½í•´ìš”. ì§€ê¸ˆì€ ì–µì§€ë¡œ ë§ì´ ì‹œí‚¤ê¸°ë³´ë‹¤, 'ë§¤ì¼ ì •í•´ì§„ ì‹œê°„ì— ì±…ìƒì— ì•‰ëŠ” í˜'ì„ ê¸¸ëŸ¬ì£¼ëŠ” ê²Œ í•µì‹¬ì…ë‹ˆë‹¤. ì €í¬ í•™ì›ì˜ ê¼¼ê¼¼í•œ ê´€ë¦¬ ì‹œìŠ¤í…œìœ¼ë¡œ 00ì´ì—ê²Œ ë”± ë§ëŠ” ê³µë¶€ ê·¼ìœ¡ì„ ë§Œë“¤ì–´ì£¼ê² ìŠµë‹ˆë‹¤.\n";
            else if (scores.cognitive >= 3 && scores.solving <= 1) report += "â–¶ [ë…¼ë¦¬ ì™„ì„±í˜•] 00ì´ëŠ” ìˆ˜í•™ì  ê°ê°ì´ íƒì›”í•´ì„œ ë‚¨ë“¤ë³´ë‹¤ ë¹ ë¥´ê²Œ ë‹µì„ ì°¾ì•„ëƒ…ë‹ˆë‹¤. ì •ë§ í° ì¥ì ì´ì—ìš”! ë‹¤ë§Œ, ê·¸ ë¹ ë¥¸ ì§ê´€ì„ 'ë…¼ë¦¬ì ì¸ ì‹'ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ì—°ìŠµë§Œ ë”í•˜ë©´ ì™„ë²½í•´ì§ˆ ê²ë‹ˆë‹¤. ì§€ê¸ˆì²˜ëŸ¼ ëˆˆìœ¼ë¡œë§Œ í’€ë©´ ê³ ë“± ê³¼ì •ì—ì„œ ì•„ê¹ê²Œ ì ìˆ˜ë¥¼ ìƒì„ ìˆ˜ ìˆì–´ìš”. 00ì´ì˜ ì²œì¬ì ì¸ ê°ê°ì„ íƒ„íƒ„í•œ ì‹¤ë ¥ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” 'ì„œìˆ í˜• ì“°ê¸° í›ˆë ¨'ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.\n";
            else if (scores.habit >= 3 && scores.cognitive <= 1) report += "â–¶ [íš¨ìœ¨ì„± ì—…ê·¸ë ˆì´ë“œí˜•] 00ì´ì˜ ê°€ì¥ í° ë¬´ê¸°ëŠ” ì„±ì‹¤í•¨ì…ë‹ˆë‹¤. ê°€ë¥´ì¹˜ëŠ” ì„ ìƒë‹˜ë“¤ì´ ì œì¼ ì˜ˆë»í•˜ëŠ” í•™ìƒì´ì£ . ê·¸ëŸ°ë° ê·¸ë™ì•ˆ ë„ˆë¬´ ì •ì§í•˜ê²Œ 'ì•”ê¸°' ìœ„ì£¼ë¡œ ê³µë¶€í•˜ëŠë¼ ì—ë„ˆì§€ë¥¼ ë§ì´ ì“´ ê²ƒ ê°™ì•„ìš”. 00ì´ì—ê²ŒëŠ” ë¬´ì¡°ê±´ ì™¸ìš°ëŠ” ê²Œ ì•„ë‹ˆë¼ 'ì™œ ê·¸ëŸ´ê¹Œ?'ë¥¼ ìƒê°í•˜ê²Œ í•˜ëŠ” íš¨ìœ¨ì ì¸ ê³µë¶€ë²•ì„ ì•Œë ¤ì¤˜ì•¼ í•©ë‹ˆë‹¤. ë…¸ë ¥í•œ ë§Œí¼, ì•„ë‹ˆ ê·¸ ì´ìƒìœ¼ë¡œ ì„±ì ì´ ë‚˜ì˜¬ ìˆ˜ ìˆë„ë¡ 'ê³µë¶€ì˜ ìš”ë ¹'ì„ ì „ìˆ˜í•˜ê² ìŠµë‹ˆë‹¤.\n";
            else if (scores.cognitive >= 3 && scores.habit >= 3 && scores.solving >= 3 && scores.affect >= 3) report += "â–¶ [ë©”íƒ€ì¸ì§€ ì™„ì„±í˜•] 00ì´ëŠ” ë‚˜ë¬´ë„ ë° ì—†ì´ í›Œë¥­í•œ ë°¸ëŸ°ìŠ¤ë¥¼ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. ì¸ì§€ ëŠ¥ë ¥, ìŠµê´€, ì •ì„œ ëª¨ë‘ ì•ˆì •ì ì´ì—ìš”. ì´ì œëŠ” 'ìµœìƒìœ„ê¶Œ ë„ì•½'ì„ ëª©í‘œë¡œ ì‚¼ì•„ì•¼ í•  ë•Œì…ë‹ˆë‹¤. ë‹¨ìˆœíˆ ë¬¸ì œë¥¼ í‘¸ëŠ” ê²ƒì„ ë„˜ì–´, ì¶œì œìì˜ ì˜ë„ë¥¼ íŒŒì•…í•˜ê³  ìì‹ ì´ ì•„ëŠ” ê²ƒê³¼ ëª¨ë¥´ëŠ” ê²ƒì„ êµ¬ë¶„í•˜ëŠ” 'ë©”íƒ€ì¸ì§€' í›ˆë ¨ì„ í†µí•´, ì–´ë–¤ ë‚œì´ë„ì˜ ë¬¸ì œë„ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ê·¹ê°•ì˜ ì‹¤ë ¥ì„ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.\n";
            else report += "â–¶ [ë°¸ëŸ°ìŠ¤ ì„±ì¥í˜•] 00ì´ëŠ” ì „ë°˜ì ìœ¼ë¡œ í° ì•½ì  ì—†ì´ ê³ ë¥¸ ì—­ëŸ‰ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë¬´í•œí•œ ì„±ì¥ ê°€ëŠ¥ì„±ì´ ë³´ì—¬ìš”! ì´ì œëŠ” ë³¸ì¸ë§Œì˜ 'ê°•ì 'ì„ í•˜ë‚˜ í™•ì‹¤í•˜ê²Œ ë§Œë“¤ ì‹œê¸°ì…ë‹ˆë‹¤. 00ì´ê°€ ê°€ì¥ ì¬ë¯¸ìˆì–´í•˜ëŠ” ë‹¨ì›ë¶€í„° ì‹œì‘í•´ ì‹¬í™” í•™ìŠµì„ ë³‘í–‰í•˜ê³ , ì¡°ê¸ˆ ë¶€ì¡±í•œ ë¶€ë¶„ì€ ê¼¼ê¼¼í•˜ê²Œ ì±„ì›Œì¤€ë‹¤ë©´ ìƒìœ„ê¶Œìœ¼ë¡œ ì¹˜ê³  ì˜¬ë¼ê°ˆ ìˆ˜ ìˆëŠ” ì¶©ë¶„í•œ ì €ë ¥ì´ ìˆìŠµë‹ˆë‹¤.\n";
            return report;
        }

        // --- Nav Handlers ---
        btnNext.addEventListener('click', () => {
            if (state.step < state.totalSteps) {
                // Step 1: History
                if (state.step === 1) {
                    if (!state.data.learningMethod) return showAlert('í˜„ì¬ ìˆ˜í•™ í•™ìŠµ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }

                // Step 2: Disposition
                if (state.step === 2) {
                    if (Object.keys(state.data.disposition).length !== 16) { return showAlert("ì •í™•í•œ ì§„ë‹¨ì„ ìœ„í•´ ëª¨ë“  í•­ëª©(16ê°œ)ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); }
                }

                // Step 3: Scheduling
                if (state.step === 3) {
                    if (state.data.consultPath === 'student_first') {
                        if (!state.data.testDate) return showAlert('í•™ìƒ í…ŒìŠ¤íŠ¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        if (state.data.testTimes.length === 0) return showAlert('í•™ìƒ í…ŒìŠ¤íŠ¸ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        if (!state.data.consultDate) return showAlert('í•™ë¶€ëª¨ë‹˜ ìƒë‹´ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        if (state.data.consultTimes.length === 0) return showAlert('í•™ë¶€ëª¨ë‹˜ ìƒë‹´ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    } else {
                        if (!state.data.consultDate) return showAlert('ë°©ë¬¸ í¬ë§ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        if (state.data.consultTimes.length === 0) return showAlert('ë°©ë¬¸ í¬ë§ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    }
                }

                // Step 4: Basic Info
                if (state.step === 4) {
                    const name = state.data.studentName.replace(/\s/g, ''); const pPhone = state.data.parentPhone; const sPhone = state.data.studentPhone; const nameRegex = /^[ê°€-í£]{2,}$/; const phoneRegex = /^010-?([0-9]{4})-?([0-9]{4})$/;
                    if (!nameRegex.test(name)) return showAlert('í•™ìƒ ì´ë¦„ì€ í•œê¸€ 2ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    if (!state.data.schoolName || !state.data.schoolGrade) return showAlert('í•™êµì™€ í•™ë…„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    if (!phoneRegex.test(pPhone)) return showAlert('ì˜¬ë°”ë¥¸ í•™ë¶€ëª¨ ì—°ë½ì²˜ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤ (010-0000-0000).');
                    if (sPhone && !phoneRegex.test(sPhone)) return showAlert('ì˜¬ë°”ë¥¸ í•™ìƒ ì—°ë½ì²˜ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                }

                state.step++; renderStep();
            } else if (state.step === state.totalSteps) { submitToGoogleSheet(); }
        });
        btnPrev.addEventListener('click', () => { if (state.step > 0) { state.step--; renderStep(); } });

        // --- Helpers ---
        window.selectMethod = (id) => { state.data.learningMethod = id; if (id === 'none') { state.data.moveReasons = []; state.data.moveReasonOther = ''; } renderHistory(); };
        window.toggleReason = (id) => { const index = state.data.moveReasons.indexOf(id); if (index === -1) state.data.moveReasons.push(id); else state.data.moveReasons.splice(index, 1); renderHistory(); };
        window.selectDisposition = (id, val) => { state.data.disposition[id] = val; renderDisposition(); };
        function getLearningMethodLabel(id) { const m = learningMethods.find(x => x.id === id); return m ? m.label : 'ë¯¸ì„ íƒ'; }

        // Expose functions to window
        window.setConsultPath = setConsultPath;
        window.updateSchoolList = updateSchoolList;
        window.checkManualSchool = checkManualSchool;

        // --- Submit ---
        async function submitToGoogleSheet() {
            if (state.isSubmitting) return;
            state.isSubmitting = true; btnNext.innerHTML = '<div class="loader"></div>';

            const dispositionKorean = Object.entries(state.data.disposition).map(([key, val]) => {
                const q = dispositionQuestions.find(q => q.id === key);
                return q ? (val === 'A' ? q.a : q.b) : '';
            }).filter(Boolean).join(', ');

            const dispositionJson = JSON.stringify(state.data.disposition);

            const payload = {
                timestamp: new Date().toISOString(), ...state.data,
                learningMethod: getLearningMethodLabel(state.data.learningMethod),
                moveReasons: [...state.data.moveReasons.map(r => moveReasons.find(x => x.id === r)?.label || r), state.data.moveReasonOther].filter(Boolean).join(', '),
                dispositionRaw: dispositionKorean,
                dispositionJson: dispositionJson,
                dispositionText: dispositionKorean,
                generatedAnalysis: state.data.generatedAnalysis,
                scheduleSummary: getScheduleSummaryHTML().replace(/<[^>]*>/g, ' ').trim()
            };

            try {
                // Vercel -> GAS API í˜¸ì¶œ
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors', // CORS ëª¨ë“œ í•„ìˆ˜
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // GASëŠ” text/plainì„ ì„ í˜¸
                    body: JSON.stringify(payload)
                });

                const res = await response.json();

                if (res.result === 'success') {
                    state.step++;
                    renderStep();
                } else {
                    // ë…¼ë¦¬ì  ì—ëŸ¬ (ì„œë²„ê°€ ëª…ì‹œì ìœ¼ë¡œ ì—ëŸ¬ë¥¼ ë³´ë‚¸ ê²½ìš°)
                    showAlert("ì „ì†¡ ì‹¤íŒ¨: " + (res.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                    btnNext.innerHTML = '<span>ì˜ˆì•½ ì™„ë£Œí•˜ê¸°</span>';
                }
            } catch (err) {
                // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬, íƒ€ì„ì•„ì›ƒ, ë˜ëŠ” JSON íŒŒì‹± ì—ëŸ¬
                // ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆë‹¤ë©´ ì´ìª½ìœ¼ë¡œ ë¹ ì ¸ë„ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                console.warn("ì„œë²„ ì‘ë‹µ ì§€ì—° ë˜ëŠ” í†µì‹  ì˜¤ë¥˜ (ë°ì´í„°ëŠ” ì €ì¥ë¨):", err);
                state.step++;
                renderStep();
            }

            state.isSubmitting = false;
        }
        renderStep();
    </script>
</body>


</html>

